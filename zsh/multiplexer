#!/usr/bin/env zsh

    TMUX_DIR="${HOME}/.jachymko/tmux"
DEFAULT_CONF="${TMUX_DIR}/tmux.conf"
 MASTER_CONF="${TMUX_DIR}/tmux.conf.master"

session='default'
 config="${DEFAULT_CONF}"
   tmux=`which tmux`

if [ ! -x "${tmux}" ]; then
    return 0
fi

if [ -n "${PARENT_TMUX}" ]; then
    return 0
fi

if [ -n "${SSH_CONNECTION}" -a -n "${TMUX}" ]; then
    return 0
fi

if [ -z "${TMUX}" -a -z "${SSH_CONNECTION}" ]; then
    # use tmux.conf.master
    config="${MASTER_CONF}"
    session='master'

    # use independent server
    tmux="${tmux} -L master"
fi

if [ -n "${TMUX}" ]; then
    PARENT_TMUX=${TMUX}
    unset TMUX
    export PARENT_TMUX
fi

cmds=''

if ! ${=tmux} has-session -t ${session} 2> /dev/null; then
    # let the inner shells know not to spawn another master tmux
    if [ -n "${PARENT_TMUX}" ]; then
        cmds+="set-environment -g PARENT_TMUX '${PARENT_TMUX}'; "
    fi
fi

cmds+="new-session -As ${session}; "

${=tmux} -f ${config} ${(z)cmds}
