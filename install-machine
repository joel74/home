#!/bin/sh

if [ `id -u` != 0 ]; then
    echo Must be root >&2
    exit 1
fi

if [ -z "$1" ]; then
    echo usage: $0 hostname >&2
    exit 1
fi

if [ -z "$JACHYMKO" ]; then
    JACHYMKO=$(cd -P -- "$(dirname $0)" && pwd -P)
fi

UNAME=`uname -s` # -s return system name, ie. Darwin or FreeBSD
HOSTNAME=$1

trycd() {
    cd $1 >/dev/null 2>&1
}

copydir() {
    if [ -d $1 ]; then
        find $1 -not -type d -print0 | xargs -I{} -0 cp -v {} /{}
    fi
}

provision() {
    (
    if trycd $1; then
        copydir etc
        copydir root

        if [ -x ./install-machine ]; then
            ./install-machine $HOSTNAME
        fi
    fi
    )
}

provision $JACHYMKO/$UNAME
provision $JACHYMKO/$UNAME/host-$HOSTNAME
