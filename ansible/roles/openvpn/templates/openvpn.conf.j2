# {{ ansible_managed }}

{% set openvpn = item %}
{% set is_client = openvpn.client | default(openvpn_client) | default(false) %}

{% if openvpn.cred is defined %}
{% set openvpn_cred = openvpn.cred %}
{% endif %}

ca   {{ openvpn_cred.ca }}
cert {{ openvpn_cred.cert }}
key  {{ openvpn_cred.key }}

dev   {{ openvpn.dev   | default(openvpn_dev) }}
proto {{ openvpn.proto | default(openvpn_proto) }}
port  {{ openvpn.port  | default(openvpn_port) }}

{% if is_client %}

    client
    nobind

{% else %}

    server {{ openvpn.ipv4.network | default(openvpn_ipv4_network) | mandatory }} {{ openvpn.ipv4.mask | default(openvpn_ipv4_mask) | mandatory }}
    dh     {{ openvpn_cred.dh }}

    {% for p in openvpn.push | default(openvpn_push) | default([]) %}
        push "{{ p }}"
    {% endfor %}

    {% if openvpn.max_clients | default(openvpn_max_clients) %}
        max-clients {{ openvpn.max_clients | default(openvpn_max_clients) }}
    {% endif %}

{% endif %}

{% if openvpn.bind_ip | default(openvpn_bind_ip) %}
    local {{ openvpn.bind_ip | default(openvpn_bind_ip) }}
{% endif %}

{% if openvpn.keepalive | default(openvpn_keepalive) %}
    keepalive   {{ openvpn.keepalive | default(openvpn_keepalive) }}
{% endif %}

{% if openvpn.status | default(openvpn_status) %}
    status      {{ openvpn.status | default(openvpn_status) }}
{% endif %}

{% if openvpn.comp_lzo | default(openvpn_comp_lzo) %}
    comp-lzo
{% endif %}

{% if openvpn.cipher | default(openvpn_cipher) %}
    cipher      {{ openvpn.cipher | default(openvpn_cipher) }}
{% endif %}

{% if openvpn.tcp_nodelay | default(openvpn_tcp_nodelay) | default(false) %}
    # disables the Nagle algorithm on TCP sockets
    # In VPN applications over TCP, TCP_NODELAY is generally
    # a good latency optimization.
    tcp-nodelay
{% endif %}

{% if openvpn.reduce_privileges | default(openvpn_reduce_privileges) | default(true) %}
    # reduce privileges
    user   nobody
    group  nobody

    {% if openvpn.chroot | default(openvpn_chroot) | default(false) %}
    chroot {{ openvpn.chroot | default(openvpn_chroot) | mandatory }}
    {% endif %}

    # The persist options will try to avoid accessing certain
    # resources on restart that may no longer be accessible because
    # of the privilege downgrade.
    persist-key
    persist-tun
{% endif %}
