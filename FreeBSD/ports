#!/bin/sh

PORTSDIR=/usr/ports
UNAMEDIR=$(dirname $0)

if [ `id -u` != 0 ]; then
    echo Must be root >&2
    exit 1
fi

if [ -z "$1" ]; then
    echo usage: $0 hostname >&2
    exit 1
fi

trycd() {
    cd $1 >/dev/null 2>&1
}

provision() {
    if trycd $1; then
        find * -not -type d -print0 | \
            xargs -I{} -0 sh -c 'make -C $PORTSDIR/{} -DBATCH $(cat {}) install clean'
    fi
}

portsnap fetch

if ! portsnap update 2>/dev/null; then
    portsnap extract
    portsnap update
fi

provision $UNAMEDIR/ports.d
provision $UNAMEDIR/host-$1/ports.d
