#!/bin/sh

PORTSDIR=${PORTSDIR-/usr/ports}
UNAMEDIR=$(cd -- $(dirname $0) && pwd -P)

if [ `id -u` != 0 ]; then
    echo Must be root >&2
    exit 1
fi

if [ -z "$1" ]; then
    echo usage: $0 hostname >&2
    exit 1
fi

trycd() {
    cd $1 >/dev/null 2>&1
}

provision() {
    if ! trycd $1; then
        return
    fi

    for action in fetch-recursive config-recursive install clean; do
        find * -type f -print0 | xargs -I{} -0 sh -c "make -C $PORTSDIR/{} -DBATCH \$(cat {}) $action"
    done
}

portsnap fetch

if ! portsnap update 2>/dev/null; then
    portsnap extract
    portsnap update
fi

provision $UNAMEDIR/ports.d
provision $UNAMEDIR/host-$1/ports.d
