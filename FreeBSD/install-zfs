#!/bin/sh

# 1. Create the necessary partitions on the disk(s) and add ZFS aware boot code.
#
#       gpart create -s gpt ada0
#       gpart add -t freebsd-boot -s 94 ada0
#       gpart add -t freebsd-zfs -l disk0 ada0
#       gpart bootcode -b/boot/pmbr -p/boot/gptzfsboot -i 1 ada0
#
# 2. Create the pool (ignore any warnings regarding mounting)
#
#       zpool create zroot /dev/gpt/disk0
#
# 3. Run this script
#
#       fetch -o - https://raw.github.com/jachymko/home/master/FreeBSD/install-zfs | sh

if [ `id -u` != 0 ]; then
    echo Must be root
    exit 1
fi

export zroot=zroot
export swap=4G
export destdir=/mnt
export compress=lz4

zpool status $zroot || exit $?

zpool set bootfs=$zroot        $zroot
zpool set lz4_compress=enabled $zroot 2>/dev/null || export compress=on

zfs set checksum=fletcher4  $zroot
zfs set mountpoint=$destdir $zroot

zpool export $zroot
zpool import -o cachefile=/var/tmp/zpool.cache $zroot

if [ $swap ]; then
    zfs create -V $swap $zroot/swap
    zfs set org.freebsd:swap=on $zroot/swap
    zfs set checksum=off $zroot/swap
fi

zfs create -o exec=on  -o setuid=off -o compression=$compress $zroot/tmp
zfs create -o exec=on  -o setuid=on  -o compression=off       $zroot/usr
zfs create -o exec=on  -o setuid=on  -o compression=off       $zroot/usr/home
zfs create -o exec=on  -o setuid=off -o compression=$compress $zroot/usr/ports
zfs create -o exec=off -o setuid=off -o compression=off       $zroot/usr/ports/distfiles
zfs create -o exec=off -o setuid=off -o compression=off       $zroot/usr/ports/packages
zfs create -o exec=off -o setuid=off -o compression=$compress $zroot/usr/src
zfs create -o exec=off -o setuid=off -o compression=off       $zroot/var
zfs create -o exec=off -o setuid=off -o compression=$compress $zroot/var/crash
zfs create -o exec=off -o setuid=off -o compression=$compress $zroot/var/db
zfs create -o exec=on  -o setuid=off -o compression=$compress $zroot/var/db/pkg
zfs create -o exec=off -o setuid=off -o compression=off       $zroot/var/empty
zfs create -o exec=off -o setuid=off -o compression=$compress $zroot/var/log
zfs create -o exec=off -o setuid=off -o compression=$compress $zroot/var/mail
zfs create -o exec=off -o setuid=off -o compression=off       $zroot/var/run
zfs create -o exec=on  -o setuid=off -o compression=$compress $zroot/var/tmp

zfs show $zroot

chmod 1777 $destdir/tmp
chmod 1777 $destdir/var/tmp

cd $destdir
ln -s usr/home home

cd /usr/freebsd-dist

for file in base.txz kernel.txz doc.txz src.txz; do
    cat $file | tar --unlink -xpJf - -C $destdir
done

cp /var/tmp/zpool.cache $destdir/boot/zfs/zpool.cache

echo 'zfs_enable="YES"'                  >> $destdir/etc/rc.conf
echo 'zfs_load="YES"'                    >> $destdir/boot/loader.conf
echo "vfs.root.mountfrom=\"zfs:$zroot\"" >> $destdir/boot/loader.conf
touch $destdir/etc/fstab

zfs set readonly=on $zroot/var/empty
zfs umount -af
zfs set mountpoint=legacy $zroot
zfs set mountpoint=/tmp   $zroot/tmp
zfs set mountpoint=/usr   $zroot/usr
zfs set mountpoint=/var   $zroot/var
